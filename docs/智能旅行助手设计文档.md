## 智能旅行助手设计文档

本文档描述 `helloagents-trip-planner` 项目的整体架构、核心模块、数据模型与关键流程，便于二次开发、排障与部署。

### 1. 项目目标与范围

- **目标**：用户输入城市、日期、偏好等信息，系统自动生成可视化、多日旅行计划，并在前端展示行程、预算、地图与天气等信息。
- **范围**：
  - 多智能体协作生成旅行计划（景点、天气、酒店、行程整合）。
  - 外部服务集成（高德地图 MCP 工具、LLM、Unsplash 图片）。
  - 前后端分离 Web 应用（FastAPI + Vue3）。

### 2. 总体架构

系统采用前后端分离架构，分为四层：

- **前端层（Vue3 + TS + Vite + Ant Design Vue）**
  - 收集用户表单输入
  - 调用后端 API 生成旅行计划
  - 展示结果页：行程概览、预算、地图、每日行程、天气等

- **后端层（FastAPI）**
  - API 路由与数据校验（Pydantic）
  - 调用多智能体系统生成旅行计划
  - 统一封装外部服务调用（MCP / Unsplash / LLM）

- **智能体层（HelloAgents）**
  - 多 Agent 分工协作：景点搜索、天气查询、酒店推荐、行程规划
  - 通过 MCP 工具调用高德地图能力

- **外部服务层**
  - **高德地图**：POI 搜索、天气、路线等（通过 MCP Server）
  - **LLM**：用于生成结构化行程与预算
  - **Unsplash**（可选）：景点图片补全

### 3. 目录结构与模块职责

```text
helloagents-trip-planner/
├── backend/
│   ├── app/
│   │   ├── agents/                 # 多智能体系统实现
│   │   │   └── trip_planner_agent.py
│   │   ├── api/                    # FastAPI 主应用与路由
│   │   │   ├── main.py
│   │   │   └── routes/
│   │   │       ├── trip.py         # 旅行规划接口
│   │   │       ├── poi.py          # POI 相关接口（含图片）
│   │   │       └── map.py          # 地图能力接口（POI/天气/路线）
│   │   ├── models/
│   │   │   └── schemas.py          # Pydantic 数据模型
│   │   ├── services/
│   │   │   ├── llm_service.py      # LLM 初始化
│   │   │   ├── amap_service.py     # 高德服务封装（如有）
│   │   │   └── unsplash_service.py # Unsplash 图片服务
│   │   └── config.py               # 配置与环境变量加载
│   ├── requirements.txt
│   └── run.py
└── frontend/
    ├── src/
    │   ├── views/
    │   │   ├── Home.vue            # 表单页
    │   │   └── Result.vue          # 结果页（地图/导出/编辑）
    │   ├── services/
    │   │   └── api.ts              # Axios API 封装
    │   ├── types/
    │   │   └── index.ts            # TS 类型定义
    │   ├── App.vue
    │   └── main.ts                 # 路由定义
    ├── vite.config.ts              # dev server 配置
    └── package.json
```

### 4. 核心数据模型（后端 Pydantic）

后端通过 `backend/app/models/schemas.py` 定义输入与输出模型，关键模型如下：

- **请求模型**：`TripRequest`
  - `city`, `start_date`, `end_date`, `travel_days`
  - `transportation`, `accommodation`, `preferences[]`, `free_text_input`

- **输出模型**：`TripPlanResponse` -> `TripPlan`
  - `TripPlan.days[]`：`DayPlan`（含景点、酒店、餐饮）
  - `TripPlan.weather_info[]`：`WeatherInfo`
  - `TripPlan.budget`：`Budget`

设计要点：
- **统一字段名**：经纬度统一为 `longitude/latitude`
- **强类型校验**：避免外部 API 字段差异导致的运行期错误

### 5. API 设计（后端）

FastAPI 主入口：`backend/app/api/main.py`，统一前缀 `/api`。

#### 5.1 旅行规划

- `POST /api/trip/plan`
  - 入参：`TripRequest`
  - 出参：`TripPlanResponse`（`success/message/data`）

- `GET /api/trip/health`
  - 返回 agent/tool 可用性（用于排查 MCP、LLM 初始化问题）

#### 5.2 地图与 POI

- `GET /api/map/poi`：POI 搜索
- `GET /api/map/weather`：天气查询
- `POST /api/map/route`：路线规划
- `GET /api/poi/photo`：按景点名取图片（可从 Unsplash/其它来源）

### 6. 多智能体协作设计

多智能体系统位于 `backend/app/agents/trip_planner_agent.py`，核心类为：

- `MultiAgentTripPlanner`
  - `attraction_agent`：景点搜索专家（调用 `amap_maps_text_search`）
  - `weather_agent`：天气查询专家（调用 `amap_maps_weather`）
  - `hotel_agent`：酒店推荐专家（调用 `amap_maps_text_search`）
  - `planner_agent`：行程规划专家（整合信息，输出 JSON）

协作流程（顺序执行）：

1. 景点 Agent：根据城市 + 偏好检索候选景点
2. 天气 Agent：按城市查询天气
3. 酒店 Agent：按城市 + 住宿偏好检索酒店
4. 规划 Agent：将以上结果与用户约束整合，生成 `TripPlan` JSON
5. 后端解析 JSON 为 `TripPlan`，返回前端

### 7. MCP 工具集成（高德地图）

#### 7.1 MCP Server 启动方式

系统通过 HelloAgents 的 `MCPTool` 启动 MCP Server，并自动展开为多个工具（如 `amap_maps_text_search`、`amap_maps_weather` 等）。

Windows 下为规避执行策略对 `npx.ps1` 的限制，使用：

- `npx.cmd -y @amap/amap-maps-mcp-server`

#### 7.2 环境变量映射

MCP Server 需要环境变量：

- `AMAP_MAPS_API_KEY`

项目中通过 `backend/.env` 提供 `AMAP_API_KEY`，并由 `MCPTool(env=...)` 注入为 `AMAP_MAPS_API_KEY`。

### 8. LLM 集成设计

LLM 由 `backend/app/services/llm_service.py` 初始化 `HelloAgentsLLM()`，并从环境变量读取配置：

- `LLM_API_KEY`
- `LLM_BASE_URL`
- `LLM_MODEL_ID`
- `LLM_TIMEOUT`

设计要点：
- 规划 Agent 输出为**严格 JSON**，后端需能从 LLM 回复中提取并解析 JSON。
- 旅行天数越长、提示词越复杂，LLM 响应越慢；需要配置足够的超时，并在前端 Axios 侧同步超时设置。

### 9. 前端设计

#### 9.1 页面与路由

路由在 `frontend/src/main.ts` 中定义：
- `/`：`Home.vue`（表单页）
- `/result`：`Result.vue`（结果页）

#### 9.2 数据流

1. Home 表单提交 -> `generateTripPlan()` 调用 `POST /api/trip/plan`
2. 成功后将 `TripPlan` 写入 `sessionStorage`，并跳转 `/result`
3. Result 页面读取 `sessionStorage`（及可选路由 state）渲染结果，并初始化高德 JS 地图

#### 9.3 地图展示

Result 页使用 `@amap/amap-jsapi-loader` 加载 JS API：
- 使用 `VITE_AMAP_WEB_JS_KEY`
- 根据景点坐标添加 Marker、绘制路线 Polyline

#### 9.4 导出与编辑

- 编辑：可调整景点顺序、删除景点并刷新地图
- 导出：`html2canvas` + `jsPDF` 导出图片/PDF（地图通过 canvas/快照策略处理）

### 10. 配置与运行

#### 10.1 后端 `.env`

- `AMAP_API_KEY`：高德 Web 服务 Key（用于 MCP Server）
- `LLM_API_KEY / LLM_BASE_URL / LLM_MODEL_ID / LLM_TIMEOUT`：LLM 配置
- `CORS_ORIGINS`：前端开发域名（默认 `http://localhost:5173`）

#### 10.2 前端 `.env`

- `VITE_API_BASE_URL=http://localhost:8000`
- `VITE_AMAP_WEB_KEY`：高德 Web Key（如需要）
- `VITE_AMAP_WEB_JS_KEY`：高德 JS API Key（地图必需）

### 11. 可靠性与异常处理

#### 11.1 常见故障点

- **前端 Network Error**：通常是后端超时 / 跨域预检失败 / 端口不一致
- **MCP 工具不可用**：`npx` 被执行策略拦截、包无法下载、`AMAP_MAPS_API_KEY` 未传入
- **LLM 超时**：模型较慢或网络不稳定，需要增大 `LLM_TIMEOUT` 与前端 Axios timeout

#### 11.2 设计策略

- 关键路径增加日志输出（请求、Agent 步骤、工具调用、LLM 重试/超时）
- 前后端统一超时配置，避免“后端仍在跑、前端先断开”

### 12. 可扩展性规划

- 新增 Agent：餐厅推荐、交通规划、预算精算等
- 新增工具来源：替换/新增图片服务、更多地图能力（静态图、周边搜索）
- 生产部署：反向代理（Nginx）、环境隔离（Docker/venv）、日志与监控

